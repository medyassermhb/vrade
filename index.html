<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BETCAM | Expertise VRADE & Décision</title>
    
    <!-- Bibliothèques Externes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f3f6; 
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
        }
        
        .pro-shadow { 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); 
        }

        .input-focus:focus { 
            border-color: #1e3a8a; /* Blue-900 focus */
            ring: 4px; 
            ring-color: rgba(30, 58, 138, 0.1); 
        }

        .font-mono-num { 
            font-variant-numeric: tabular-nums; 
            letter-spacing: -0.02em;
        }

        .seniority-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 8px 12px -3px rgba(16, 185, 129, 0.15);
        }

        .logo-box {
            width: 60px;
            height: 60px;
            background: #1e3a8a; /* Blue-900 */
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px -4px rgba(30, 58, 138, 0.4);
            color: white;
            font-size: 1.8rem;
        }

        .decision-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Toggle Checkbox Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
        .hidden-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .visible-section {
            display: block;
            opacity: 1;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        html { scroll-behavior: smooth; }

        /* Styles spécifiques au PDF caché */
        #pdf-export-template {
            display: none; /* Caché par défaut */
            background: white;
            color: black;
            padding: 30px;
            width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            margin: 0 auto;
            position: relative;
        }

        /* Overlay de chargement propre */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f1f3f6; /* Même couleur que le fond */
            z-index: 99999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media print {
            .no-print { display: none; }
        }
        
        /* Custom Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #1e3a8a;
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }

        /* Checkbox list style */
        .checkbox-item {
            display: flex;
            align-items: start;
            gap: 8px;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .checkbox-item:hover {
            background-color: #fef2f2; /* Default red hover */
        }
        .checkbox-item-eco:hover {
            background-color: #fff7ed; /* Orange hover for eco */
        }
    </style>
</head>
<body class="text-slate-800 antialiased p-4 md:p-8 bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-blue-900 text-4xl mb-4">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>
        <p class="text-blue-900 font-bold uppercase tracking-widest text-sm">Génération du PDF...</p>
    </div>

    <!-- Ajout de l'ID app-wrapper pour le masquage lors de l'export -->
    <div id="app-wrapper" class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-5 rounded-[2rem] shadow-sm border border-white/40">
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="logo-box flex-shrink-0">
                    <!-- LOGO SVG (Bouclier Expertise) -->
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-blue-900 tracking-tight leading-none mb-1">Cabinet D'expertise <span class="font-extrabold">BETCAM</span></h1>
                    <div class="text-blue-900/70 text-[10px] font-bold tracking-widest uppercase leading-snug">
                        Bureau d'Etudes Techniques - Expertises<br>et Conseils Automobiles et Machines Agricoles
                    </div>
                </div>
            </div>
            
            <!-- Boutons Actions -->
            <div class="flex items-center gap-3 w-full md:w-auto justify-end no-print">
                <button onclick="window.location.reload()" class="h-10 w-10 flex items-center justify-center bg-white text-blue-900 border border-blue-200 rounded-xl hover:bg-blue-50 transition-all" title="Réinitialiser">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                
                <button onclick="downloadExpertisePDF()" class="h-10 px-5 bg-blue-900 text-white rounded-xl text-xs md:text-sm font-bold hover:bg-blue-950 transition-all flex items-center gap-2 shadow-md shadow-blue-200">
                    <i class="fa-solid fa-file-pdf"></i> <span>Télécharger le PDF</span>
                </button>
            </div>
        </header>

        <!-- Main Workspace -->
        <section class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Parameters Sidebar (Saisie) -->
            <div class="lg:col-span-4 space-y-5 no-print">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 space-y-5">
                    <h2 class="text-sm font-bold text-blue-900 uppercase tracking-[0.2em] mb-2 text-center border-b border-blue-50 pb-3">Données du Dossier</h2>
                    
                    <div class="space-y-4">
                        
                        <!-- Reference Dossier & N Sinistre -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Référence Dossier</label>
                                <input type="text" id="v_ref" placeholder="Ex: 26/001/A" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">N° Sinistre</label>
                                <input type="text" id="v_num_sinistre" placeholder="Ex: 100/2026" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                            </div>
                        </div>

                        <!-- Nom Assuré -->
                        <div>
                            <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Nom de l'Assuré</label>
                            <input type="text" id="v_nom_assure" placeholder="Nom Prénom / Société" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                        </div>

                        <!-- Compagnie d'Assurance (NOUVEAU) -->
                        <div>
                            <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Compagnie d'Assurance</label>
                            <input type="text" id="v_cie_assurance" placeholder="Ex: AXA / Wafa / RMA..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                        </div>

                        <!-- Marque & Immatriculation -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Marque / Modèle</label>
                                <input type="text" id="v_marque_modele" placeholder="Ex: Renault Clio" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Immatriculation</label>
                                <input type="text" id="v_mat" placeholder="Ex: 12345-A-1" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-semibold text-slate-900 placeholder-slate-400">
                            </div>
                        </div>

                        <!-- BLOC ENCADRÉ DATES (CHRONOLOGIE) -->
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 relative">
                            <div class="absolute -top-2 left-3 bg-white px-2 text-[9px] font-bold text-slate-400 uppercase tracking-widest border border-slate-100 rounded">Chronologie</div>
                            <div class="grid grid-cols-2 gap-4 mb-3 mt-1">
                                <div>
                                    <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Date MEC</label>
                                    <input type="date" id="v_dmec" value="2016-11-07" class="w-full p-2.5 bg-white border border-slate-200 rounded-xl input-focus outline-none text-sm font-medium text-slate-700" onchange="updateVrade()">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Date Sinistre</label>
                                    <input type="date" id="v_sinistre" value="2026-02-01" class="w-full p-2.5 bg-white border border-slate-200 rounded-xl input-focus outline-none text-sm font-medium text-slate-700" onchange="updateVrade()">
                                </div>
                            </div>
                            <div class="border-t border-slate-200 pt-3">
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Date de l'Expertise</label>
                                <input type="date" id="v_date_expertise" class="w-full p-2.5 bg-white border border-slate-200 rounded-xl input-focus outline-none text-sm font-medium text-slate-700">
                            </div>
                        </div>

                        <!-- BLOC ENCADRÉ FINANCIER -->
                        <div class="bg-blue-50/40 p-4 rounded-2xl border border-blue-100 relative">
                            <div class="absolute -top-2 left-3 bg-white px-2 text-[9px] font-bold text-blue-400 uppercase tracking-widest border border-blue-100 rounded">Données Financières</div>
                            
                            <div class="mt-2 mb-4">
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1">Valeur à Neuf / Facture (Dhs)</label>
                                <input type="text" id="v_valeur_display" placeholder="Saisir montant..." class="w-full p-2.5 bg-white border border-blue-200 rounded-xl input-focus outline-none font-bold text-sm text-slate-900 placeholder-slate-300" 
                                       oninput="updateVrade();" 
                                       onblur="finalizeFormat(this, 'v_valeur_raw')"
                                       onkeydown="handleEnter(event, this)">
                                <input type="hidden" id="v_valeur_raw" value="0">
                            </div>

                            <div class="border-t border-blue-200/50 pt-4 space-y-4">
                                <div>
                                    <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1">Montant du Devis (Dhs)</label>
                                    <input type="text" id="v_devis_display" placeholder="Saisir montant..." class="w-full p-2.5 bg-white border border-blue-200 rounded-xl input-focus outline-none font-bold text-sm text-blue-900 placeholder-blue-300" 
                                           oninput="updateVrade();" 
                                           onblur="finalizeFormat(this, 'v_devis_raw')"
                                           onkeydown="handleEnter(event, this)">
                                    <input type="hidden" id="v_devis_raw" value="0">
                                </div>

                                <div>
                                    <div class="flex items-center justify-between mb-1">
                                        <label class="block text-[10px] font-bold text-emerald-800 uppercase tracking-widest">Accord sur Devis (Dhs)</label>
                                        <span class="text-[8px] px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-bold border border-emerald-200">OPTIONNEL</span>
                                    </div>
                                    <input type="text" id="v_accord_display" placeholder="Saisir accord..." class="w-full p-2.5 bg-emerald-50 border border-emerald-200 rounded-xl input-focus outline-none font-bold text-sm text-emerald-700 placeholder-emerald-300" 
                                           oninput="updateVrade();" 
                                           onblur="finalizeFormat(this, 'v_accord_raw')"
                                           onkeydown="handleEnter(event, this)">
                                    <input type="hidden" id="v_accord_raw" value="0">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Catégorie</label>
                            <select id="v_cat" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-medium appearance-none cursor-pointer text-slate-700" onchange="updateVrade()">
                                <optgroup label="Véhicules Légers">
                                    <option value="PP/Non Utilitaire" selected>VH Particulier / Non Utilitaire</option>
                                    <option value="Location/Utilitaire">VH Location / Utilitaire</option>
                                </optgroup>
                                <optgroup label="Poids Lourds & Chantier">
                                    <option value="Semi-Remorque">Semi-Remorque (Tracteur)</option>
                                    <option value="Bus et Camions">Bus et Camions</option>
                                    <option value="Engins/Agricole">Engins de Chantier / Agricole</option>
                                </optgroup>
                                <optgroup label="Autres">
                                    <option value="Motocycle">Motocycle</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Puissance (CV)</label>
                                <input type="number" id="v_pf" value="6" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none font-medium text-sm text-slate-700" oninput="updateVrade()">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Carburant</label>
                                <select id="v_carb" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl input-focus outline-none text-sm font-medium cursor-pointer text-slate-700" onchange="updateVrade()">
                                    <option value="Diesel" selected>Diesel</option>
                                    <option value="Essence">Essence</option>
                                </select>
                            </div>
                        </div>

                        <!-- SECTION CRITÈRES DE RÉFORME TECHNIQUE (CHOIX MULTIPLE) -->
                        <div class="pt-4 border-t border-slate-100">
                            <div class="bg-red-50 p-4 rounded-2xl border border-red-100">
                                <div class="flex items-center justify-between mb-2">
                                    <label for="chk_tech_reform" class="text-[10px] font-bold text-red-700 uppercase tracking-widest cursor-pointer select-none">Véhicule Techniquement Irréparable ?</label>
                                    <input type="checkbox" id="chk_tech_reform" class="w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" onchange="toggleTechReason()">
                                </div>
                                
                                <div id="tech_reason_container" class="hidden-section mt-2">
                                    <label class="block text-[10px] font-bold text-red-400 uppercase tracking-widest mb-2 ml-1">Motifs (Choix Multiples)</label>
                                    
                                    <div class="bg-white border border-red-200 rounded-xl p-3 space-y-1 text-xs text-red-900">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Véhicule intégralement calciné" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Véhicule intégralement calciné</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Immersion totale (Inondation)" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Immersion totale (Inondation)</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Géométrie impossible à rétablir" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Géométrie impossible à rétablir</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Structure porteuse gravement endommagée" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Structure porteuse gravement endommagée</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Déformation des longerons ou du châssis" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Déformation des longerons ou du châssis</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Défaillance des systèmes de sécurité" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Défaillance des systèmes de sécurité</span>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="tech_reason" value="Numéro de série (VIN) illisible ou absent" class="mt-0.5 rounded text-red-600 focus:ring-red-500" onchange="updateVrade()">
                                            <span>Numéro de série (VIN) illisible ou absent</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                         <!-- SECTION CRITÈRES DE RÉFORME ÉCONOMIQUE (CHOIX MULTIPLE) -->
                        <div class="pt-4 border-t border-slate-100">
                            <div class="bg-orange-50 p-4 rounded-2xl border border-orange-100">
                                <div class="flex items-center justify-between mb-2">
                                    <label for="chk_eco_reform" class="text-[10px] font-bold text-orange-700 uppercase tracking-widest cursor-pointer select-none">Critères de Réforme Économique</label>
                                    <input type="checkbox" id="chk_eco_reform" class="w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500 cursor-pointer" onchange="toggleEcoReason()">
                                </div>
                                
                                <div id="eco_reason_container" class="hidden-section mt-2">
                                    <label class="block text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-2 ml-1">Motifs Administratifs (Choix Multiples)</label>
                                    
                                    <div class="bg-white border border-orange-200 rounded-xl p-3 space-y-1 text-xs text-orange-900">
                                        <div class="checkbox-item checkbox-item-eco">
                                            <input type="checkbox" name="eco_reason" value="Procédure VEI (Réparations > Valeur)" class="mt-0.5 rounded text-orange-600 focus:ring-orange-500" onchange="updateVrade()">
                                            <span>Procédure VEI (Véhicule Économiquement Irréparable)</span>
                                        </div>
                                        <div class="checkbox-item checkbox-item-eco">
                                            <input type="checkbox" name="eco_reason" value="Indisponibilité des pièces de rechange" class="mt-0.5 rounded text-orange-600 focus:ring-orange-500" onchange="updateVrade()">
                                            <span>Indisponibilité des pièces de rechange</span>
                                        </div>
                                        <div class="checkbox-item checkbox-item-eco">
                                            <input type="checkbox" name="eco_reason" value="Valeur de sauvetage élevée" class="mt-0.5 rounded text-orange-600 focus:ring-orange-500" onchange="updateVrade()">
                                            <span>Valeur de sauvetage élevée (Epave)</span>
                                        </div>
                                        <div class="checkbox-item checkbox-item-eco">
                                            <input type="checkbox" name="eco_reason" value="Accord Commercial / Assureur" class="mt-0.5 rounded text-orange-600 focus:ring-orange-500" onchange="updateVrade()">
                                            <span>Accord Commercial / Assureur</span>
                                        </div>
                                        <div class="checkbox-item checkbox-item-eco">
                                            <input type="checkbox" name="eco_reason" value="Risque d'aléas importants au démontage" class="mt-0.5 rounded text-orange-600 focus:ring-orange-500" onchange="updateVrade()">
                                            <span>Risque d'aléas importants au démontage</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BLOC OPTIONS CORRECTIFS & SEUIL -->
                        <div class="pt-4 border-t border-slate-100">
                             <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-4">
                                 <!-- Ligne 1 : Facteurs Correctifs -->
                                 <div class="flex items-center justify-between">
                                     <label for="chk_correctives" class="text-[10px] font-bold text-blue-900 uppercase tracking-widest cursor-pointer select-none">
                                         APPLIQUER FACTEURS CORRECTIFS
                                     </label>
                                     <input type="checkbox" id="chk_correctives" class="w-5 h-5 text-blue-900 rounded border-gray-300 focus:ring-blue-900 cursor-pointer transition-colors" onchange="toggleCorrectives()">
                                 </div>
                                 
                                 <!-- Ligne 2 : Seuil -->
                                 <div class="flex items-center justify-between border-t border-slate-100 pt-4">
                                     <label for="chk_apply_to_threshold" class="text-[10px] font-bold text-blue-900 uppercase tracking-widest cursor-pointer select-none flex items-center gap-2">
                                         <span>APPLIQUER CORRECTIFS SUR SEUIL (2/3)</span>
                                     </label>
                                     <input type="checkbox" id="chk_apply_to_threshold" class="w-5 h-5 text-blue-900 rounded border-gray-300 focus:ring-blue-900 cursor-pointer transition-colors" onchange="updateVrade()">
                                 </div>
                             </div>

                             <!-- Contenu Déroulant Correctifs -->
                             <div id="container_correctifs" class="hidden-section mt-3">
                                 <div class="grid grid-cols-2 gap-4 bg-blue-50/30 p-3 rounded-xl border border-blue-100">
                                    <!-- KM Section -->
                                    <div>
                                        <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">KM Compteur</label>
                                        <input type="number" id="v_km_compteur" value="0" placeholder="Ex: 150000" class="w-full p-2 bg-white border border-slate-200 rounded-xl input-focus outline-none font-mono-num text-sm text-center" oninput="updateVrade()">
                                        
                                        <!-- KM Impact Display -->
                                        <div class="mt-2 text-right">
                                            <div class="w-full p-1.5 bg-white/50 rounded-lg font-mono-num text-xs font-bold text-slate-500">
                                                <span id="disp_adj_km">0,00 Dhs</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Entretien Section -->
                                    <div>
                                        <label class="block text-[10px] font-bold text-blue-900 uppercase tracking-widest mb-1.5">Entretien</label>
                                        <select id="v_entretien" class="w-full p-2 bg-white border border-slate-200 rounded-xl input-focus outline-none text-xs font-medium cursor-pointer" onchange="updateVrade()">
                                            <option value="0">Standard (0%)</option>
                                            <option value="10">Suivi Concessionnaire (+10%)</option>
                                            <option value="5">Bon État (+5%)</option>
                                            <option value="-5">Moyen (-5%)</option>
                                            <option value="-10">Mauvais (-10%)</option>
                                        </select>

                                        <!-- Entretien Impact Display -->
                                        <div class="mt-2 text-right">
                                            <div class="w-full p-1.5 bg-white/50 rounded-lg font-mono-num text-xs font-bold text-slate-500">
                                                <span id="disp_adj_ent">0,00 Dhs</span>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="p-5 bg-blue-900 text-white rounded-[2rem] shadow-lg border border-blue-800">
                    <h4 class="text-xs font-bold uppercase tracking-widest mb-2 opacity-80">Règle de Réforme</h4>
                    <p class="text-xs leading-relaxed font-normal">
                        Un véhicule est déclaré en <span class="font-bold underline">Réforme Économique</span> si le montant des réparations excède les <span class="font-bold">2/3 (66.67%)</span> de sa <span class="text-blue-200 font-medium">Valeur Technique</span>.
                    </p>
                </div>
            </div>

            <!-- Results Dashboard -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                
                <!-- Décision Technique Card -->
                <div id="decision-box" class="decision-card bg-white p-8 rounded-[2.5rem] shadow-sm border-t-8 border-slate-200 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden">
                    <div class="flex items-center gap-6">
                        <div id="decision-icon-bg" class="w-20 h-20 bg-slate-100 rounded-3xl flex items-center justify-center text-3xl text-slate-400 shadow-inner">
                            <i id="decision-icon" class="fa-solid fa-scale-balanced"></i>
                        </div>
                        <div>
                            <p class="text-blue-900 text-[11px] font-bold uppercase tracking-[0.2em] mb-1">EXPERTISE TECHNIQUE</p>
                            <h2 id="decision-label" class="text-2xl md:text-3xl font-medium text-slate-900 leading-tight">En attente de saisie</h2>
                            <p id="decision-sub" class="text-xs text-slate-500 mt-1 font-medium hidden leading-relaxed">Motifs : <span id="decision-reason" class="block mt-1 font-bold"></span></p>
                        </div>
                    </div>
                    <div class="text-center md:text-right border-t md:border-t-0 md:border-l border-slate-100 pt-4 md:pt-0 md:pl-8">
                        <p class="text-blue-900 text-[11px] font-bold uppercase tracking-widest mb-1" id="kpi-seuil-label">Seuil Réforme (2/3 de Base)</p>
                        <p id="kpi-seuil" class="text-xl font-medium font-mono-num text-slate-700">0,00 Dhs</p>
                    </div>
                </div>

                <!-- KPIs Principaux -->
                <div class="bg-blue-950 p-10 rounded-[2.5rem] text-white shadow-lg flex flex-col md:flex-row justify-between items-center gap-8 relative overflow-hidden border border-blue-900">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                        <svg viewBox="0 0 100 100" class="w-full h-full"><path d="M0 100 L100 0 L100 100 Z" fill="white"/></svg>
                    </div>
                    <div class="relative z-10 text-center md:text-left flex-1">
                        <p class="text-blue-200 text-[11px] font-bold uppercase tracking-[0.3em] mb-2">Valeur Vénale <span id="label-vv-type">Standard</span></p>
                        <h3 class="text-4xl font-medium mt-1 font-mono-num tracking-tight" id="kpi-vv-final">0,00 Dhs</h3>
                        <p class="text-slate-400 text-[11px] mt-2 font-normal" id="label-vv-sub">Calcul sur dépréciation temporelle</p>
                    </div>
                    <div class="text-right border-l border-white/10 pl-10 hidden md:block relative z-10">
                        <div class="mb-4">
                            <p class="text-white/60 text-[11px] font-bold uppercase tracking-[0.2em] mb-1">Valeur Base (Temps)</p>
                            <p class="text-lg font-medium text-white/90 font-mono-num" id="kpi-val-base">0,00 Dhs</p>
                        </div>
                        <div>
                            <p class="text-white/60 text-[11px] font-bold uppercase tracking-[0.2em] mb-1">Impact Correctifs</p>
                            <p class="text-lg font-medium text-emerald-400 font-mono-num" id="kpi-impact-total">0,00 Dhs</p>
                        </div>
                    </div>
                </div>

                <!-- Graphs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col">
                        <h4 class="text-[11px] font-bold text-blue-900 uppercase tracking-[0.2em] mb-6 text-center">Courbe de Vétusté</h4>
                        <div class="chart-container"><canvas id="chartEvo"></canvas></div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col">
                        <h4 class="text-[11px] font-bold text-blue-900 uppercase tracking-[0.2em] mb-6 text-center">Composition Valeur</h4>
                        <div class="chart-container"><canvas id="chartDist"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Audit Table -->
        <section class="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden no-print">
            
            <!-- Wrapper pour masquer le tableau en cas de réforme technique -->
            <div id="ui-audit-section">
                <div class="p-8 border-b border-slate-50 bg-slate-50/30 flex flex-col md:flex-row justify-between items-start md:items-center gap-8">
                    <div>
                        <h3 class="text-xl font-bold text-indigo-900 tracking-tight mb-1">Prorata Temporis</h3>
                        <p class="text-sm text-blue-800 font-medium">Certification établie par le Cabinet BETCAM.</p>
                    </div>
                    <div class="seniority-badge px-6 py-3.5 text-white rounded-2xl flex items-center gap-4 border border-emerald-400/30 shadow-lg shadow-emerald-100/50" id="kpi-anciennete-container">
                        <i class="fa-solid fa-calendar-check text-xl opacity-60"></i>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-bold text-emerald-100 tracking-widest uppercase">ANCIENNETÉ</span>
                            <span class="text-xl font-bold tracking-tight leading-none" id="kpi-anciennete">0 ans, 0 jrs</span>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse font-mono-num text-sm">
                        <thead>
                            <tr class="text-[11px] font-bold text-blue-900 uppercase tracking-[0.15em] bg-blue-50/30">
                                <th class="p-6 border-b border-blue-100">Année</th>
                                <th class="p-6 border-b border-blue-100">Période d'application</th>
                                <th class="p-6 border-b border-blue-100 text-center">Taux (%)</th>
                                <th class="p-6 border-b border-blue-100 text-right">Val. Début (Dhs)</th>
                                <th class="p-6 border-b border-blue-100 text-right">Dépréciation (Dhs)</th>
                                <th class="p-6 border-b border-blue-100 text-right font-bold text-blue-950">Val. Fin (Dhs)</th>
                                <th class="p-6 border-b border-blue-100 text-center">Jours</th>
                            </tr>
                        </thead>
                        <tbody id="vradeTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>

            <!-- RECAP TABLE -->
            <div class="bg-slate-50/50 p-8 border-t border-slate-100">
                <h4 class="text-[11px] font-bold text-blue-900 uppercase tracking-[0.2em] mb-4 text-center">Récapitulatif Financier</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm font-mono-num border border-slate-200 rounded-xl bg-white">
                        <thead class="bg-blue-50 text-[11px] uppercase font-bold text-blue-900">
                            <tr>
                                <th class="p-4 border-b border-r border-slate-200 text-center">Valeur à Neuf</th>
                                <th class="p-4 border-b border-r border-slate-200 text-center">Valeur Base (Temps)</th>
                                <th class="p-4 border-b border-r border-slate-200 text-center">Impact Correctifs</th>
                                <th class="p-4 border-b border-r border-slate-200 text-center bg-blue-100/50 text-blue-900">Valeur Vénale Technique</th>
                                <th class="p-4 border-b border-slate-200 text-center" id="dash_recap_seuil_label">Seuil (2/3 Base)</th>
                            </tr>
                        </thead>
                        <tbody class="text-center font-medium text-slate-700">
                            <tr>
                                <td class="p-4 border-r border-slate-200" id="dash_recap_val_neuf">0,00 Dhs</td>
                                <td class="p-4 border-r border-slate-200" id="dash_recap_val_base">0,00 Dhs</td>
                                <td class="p-4 border-r border-slate-200" id="dash_recap_impact">0,00 Dhs</td>
                                <td class="p-4 border-r border-slate-200 bg-blue-50/30 font-bold text-blue-900 text-lg" id="dash_recap_val_venale">0,00 Dhs</td>
                                <td class="p-4" id="dash_recap_seuil">0,00 Dhs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NOUVELLE SECTION : MAJORATION MARCHÉ -->
            <div class="bg-emerald-50/30 p-8 border-t border-slate-100">
                <h4 class="text-[11px] font-bold text-blue-900 uppercase tracking-[0.2em] mb-6 text-center flex items-center justify-center gap-2">
                    <i class="fa-solid fa-chart-line"></i> Ajustement Expert : Marché & État
                </h4>
                
                <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl border border-emerald-100 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs font-bold text-slate-600 uppercase tracking-wide">Majoration (Propreté / Marché / Rareté)</label>
                        <span id="market-percent-display" class="px-3 py-1 bg-emerald-100 text-emerald-800 rounded-lg text-xs font-bold font-mono-num">+0%</span>
                    </div>
                    
                    <input type="range" id="v_market_boost" min="0" max="50" value="0" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-900" oninput="updateVrade()">
                    
                    <div class="flex justify-between text-[10px] text-slate-400 mt-2 font-medium">
                        <span>0%</span>
                        <span>+25%</span>
                        <span>+50%</span>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-50 flex justify-between items-end">
                        <div class="text-xs text-slate-500">
                            Impact sur la valeur : <span id="market-value-added" class="font-bold text-emerald-600 font-mono-num">+0,00 Dhs</span>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">Valeur Vénale Retenue</p>
                            <p id="kpi-final-retained" class="text-2xl font-extrabold text-blue-900 font-mono-num">0,00 Dhs</p>
                        </div>
                    </div>
                </div>
                
                <p class="text-center text-[10px] text-slate-400 italic mt-4 max-w-lg mx-auto">
                    * Cet ajustement augmente la Valeur Vénale Finale mais n'affecte PAS le seuil de réforme économique (2/3 de la valeur technique), conformément aux procédures d'expertise.
                </p>
            </div>
        </section>

        <footer class="text-center text-blue-900 text-[11px] font-bold uppercase tracking-[0.2em] pb-12 opacity-80 no-print mt-8">
            <p>© 2026 Cabinet D'expertise BETCAM - Document certifié conforme.</p>
        </footer>
    </div> <!-- Fin du app-wrapper -->

    <!-- ========================================== -->
    <!-- TEMPLATE CACHÉ POUR L'EXPORT PDF           -->
    <!-- ========================================== -->
    <div id="pdf-export-template">
        <!-- Changed height from 100% to auto to prevent overflow, added max-width constraint -->
        <div style="width: 100%; box-sizing: border-box; background: white; padding: 20px 30px; display: flex; flex-direction: column; height: 297mm;">
            
            <div style="flex: 1;"> <!-- Content Wrapper -->
                <!-- Header PDF (Compacté) -->
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e3a8a; padding-bottom: 8px; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- LOGO SVG (Bouclier Expertise) for PDF -->
                        <div style="width: 28px; height: 28px; color: #1e3a8a;">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                <path d="m9 12 2 2 4-4"/>
                            </svg>
                        </div>
                        <div>
                            <h1 style="margin:0; color:#1e3a8a; font-size: 16px; font-weight: 800;">Cabinet D'expertise <span style="color:#1e3a8a;">BETCAM</span></h1>
                            <p style="margin:1px 0 0; color:#1e3a8a; font-size: 6px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;">
                                Bureau d'Etudes Techniques - Expertises<br>et Conseils Automobiles et Machines Agricoles
                            </p>
                        </div>
                    </div>
                    <div style="text-align: right; color: #1e3a8a; font-size: 8px;">
                        Établi le : <span id="pdf-date-now" style="font-weight: 700; color: #000;">--/--/----</span><br>
                        Réf : <span id="pdf-ref-display" style="color: #000; font-weight: 600;">VRADE-AUTOGEN</span>
                    </div>
                </div>

                <!-- BANNER TITLE -->
                <div style="text-align: center; border-top: 2px solid #1e3a8a; border-bottom: 2px solid #1e3a8a; margin: 8px 0 12px 0; padding: 6px 0; background-color: #eff6ff;">
                    <h1 style="margin: 0; font-size: 16px; font-weight: 800; color: #1e3a8a; letter-spacing: 2px; text-transform: uppercase;">FICHE RÉFORME</h1>
                </div>

                <!-- 1. IDENTIFICATION (Tableau mis à jour avec Compagnie et espacement) -->
                <div style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; margin-bottom: 8px; background-color: #f8fafc;">
                    <h2 style="font-size: 11px; font-weight: 800; text-transform: uppercase; color: #1e3a8a; margin: 0 0 6px 0; border-bottom: 1px solid #cbd5e1; padding-bottom: 4px;">1. IDENTIFICATION</h2>
                    <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 4px 6px; width: 25%; font-weight: 600; color: #64748b;">Assuré :</td>
                            <td id="pdf-nom-assure" style="padding: 4px 6px; width: 25%; font-weight: 700;">--</td>
                            <td style="padding: 4px 6px; width: 25%; font-weight: 600; color: #64748b;">N° Sinistre :</td>
                            <td id="pdf-num-sinistre" style="padding: 4px 6px; width: 25%; font-weight: 700;">--</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Compagnie :</td>
                            <td id="pdf-cie-assurance" style="padding: 4px 6px; font-weight: 700;">--</td>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Immatriculation :</td>
                            <td id="pdf-mat" style="padding: 4px 6px; font-weight: 700;">--</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Marque / Modèle :</td>
                            <td id="pdf-marque-modele" style="padding: 4px 6px; font-weight: 700; text-transform: uppercase;">--</td>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Kilométrage :</td>
                            <td id="pdf-km" style="padding: 4px 6px; font-weight: 700;">0 km</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Énergie :</td>
                            <td id="pdf-energie" style="padding: 4px 6px; font-weight: 700;">--</td>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Puissance Fiscale :</td>
                            <td id="pdf-puissance" style="padding: 4px 6px; font-weight: 700;">--</td>
                        </tr>
                        <!-- NEW ROW -->
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Catégorie :</td>
                            <td id="pdf-cat" colspan="3" style="padding: 4px 6px; font-weight: 700;">--</td>
                        </tr>
                    </table>
                </div>

                <!-- 2. CHRONOLOGIE -->
                <div style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; margin-bottom: 8px; background-color: #fff;">
                    <h2 style="font-size: 11px; font-weight: 800; text-transform: uppercase; color: #1e3a8a; margin: 0 0 6px 0; border-bottom: 1px solid #cbd5e1; padding-bottom: 4px;">2. CHRONOLOGIE</h2>
                    <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 4px 6px; width: 25%; font-weight: 600; color: #64748b;">Mise en circulation :</td>
                            <td id="pdf-dmec" style="padding: 4px 6px; width: 25%; font-weight: 700;">--/--/----</td>
                            <td style="padding: 4px 6px; width: 25%; font-weight: 600; color: #64748b;">Date du Sinistre :</td>
                            <td id="pdf-sinistre" style="padding: 4px 6px; width: 25%; font-weight: 700;">--/--/----</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Date Expertise :</td>
                            <td id="pdf-date-expertise" style="padding: 4px 6px; font-weight: 700;">--/--/----</td>
                            <td style="padding: 4px 6px; font-weight: 600; color: #64748b;">Ancienneté :</td>
                            <td id="pdf-anciennete" style="padding: 4px 6px; font-weight: 700;">0 ans, 0 jrs</td>
                        </tr>
                    </table>
                </div>

                <!-- 3. DONNÉES FINANCIÈRES -->
                <div style="border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; margin-bottom: 8px; background-color: #f0f9ff;">
                    <h2 style="font-size: 11px; font-weight: 800; text-transform: uppercase; color: #1e3a8a; margin: 0 0 6px 0; border-bottom: 1px solid #cbd5e1; padding-bottom: 4px;">3. DONNÉES FINANCIÈRES</h2>
                    <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 4px 6px; width: 40%; font-weight: 600; color: #1e3a8a;">Valeur à Neuf :</td>
                            <td id="pdf-val-neuve" style="padding: 4px 6px; font-weight: 700; text-align: right;">0,00 Dhs</td>
                        </tr>
                        <tr>
                            <td style="padding: 4px 6px; font-weight: 600; color: #1e3a8a;">Montant Devis :</td>
                            <td id="pdf-devis" style="padding: 4px 6px; font-weight: 700; text-align: right;">0,00 Dhs</td>
                        </tr>
                        <tr id="pdf-row-accord" style="display:none;">
                            <td style="padding: 4px 6px; font-weight: 700; color: #059669;">Accord sur Devis :</td>
                            <td id="pdf-accord" style="padding: 4px 6px; font-weight: 700; text-align: right; color: #059669;">0,00 Dhs</td>
                        </tr>
                    </table>
                </div>

                <!-- RECAP TABLE -->
                <div id="pdf-recap-section" style="margin-bottom: 8px;">
                    <h2 style="font-size: 11px; font-weight: 800; text-transform: uppercase; color: #1e3a8a; margin-bottom: 6px; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">4. RÉCAPITULATIF CALCUL</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; text-align: center; color: #000; border: 1px solid #e2e8f0;">
                        <thead style="background: #f1f5f9; color: #1e3a8a; font-weight: 700; text-transform: uppercase;">
                            <tr>
                                <th style="padding: 6px; border-right: 1px solid #e2e8f0;">Valeur Base</th>
                                <th style="padding: 6px; border-right: 1px solid #e2e8f0;">Correctifs</th>
                                <th style="padding: 6px; border-right: 1px solid #e2e8f0; background: #e0f2fe;">VRADE Technique</th>
                                <th style="padding: 6px;">Seuil (2/3)</th>
                            </tr>
                        </thead>
                        <tbody style="font-weight: 500;">
                            <tr>
                                <td id="pdf-recap-val-base" style="padding: 6px; border-right: 1px solid #e2e8f0;">0,00 Dhs</td>
                                <td id="pdf-recap-impact" style="padding: 6px; border-right: 1px solid #e2e8f0;">0,00 Dhs</td>
                                <!-- Added ID here for injection -->
                                <td id="pdf-vv-final" style="display:none;"></td> 
                                <td id="pdf-recap-val-venale" style="padding: 6px; border-right: 1px solid #e2e8f0; font-weight: 700; color: #1e3a8a; background: #f0f9ff;">0,00 Dhs</td>
                                <td id="pdf-recap-seuil" style="padding: 6px;">0,00 Dhs</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- DECISION BOX -->
                <div style="background-color: #fff; border: 2px solid #e2e8f0; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 12px;">
                    <div id="pdf-decision-box" style="font-weight: 800; font-size: 15px; color: #1e3a8a; text-transform: uppercase;">-- DÉCISION --</div>
                    <div id="pdf-tech-reason" style="display:none; text-align: center; margin-top: 8px; font-size: 10px; font-weight: 600; color: #dc2626;">
                        <div id="pdf-tech-reason-text"></div>
                    </div>
                </div>

                <!-- Tableau Audit PDF - Section à masquer si réforme technique -->
                <div id="pdf-audit-section">
                    <h2 style="font-size: 11px; font-weight: 800; text-transform: uppercase; color: #1e3a8a; margin-bottom: 6px; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px;">5. DÉTAIL DÉPRÉCIATION</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9px; text-align: left; color: #000;">
                        <thead>
                            <tr style="background: #f1f5f9; color: #1e3a8a; border-bottom: 1px solid #1e3a8a;">
                                <th style="padding: 4px 6px; border: 1px solid #e2e8f0; font-weight: 700;">Année</th>
                                <th style="padding: 4px 6px; border: 1px solid #e2e8f0; font-weight: 700;">Période</th>
                                <th style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: center; font-weight: 700;">Taux</th>
                                <th style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 700;">Dépréciation</th>
                                <th style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 700;">Valeur Fin</th>
                            </tr>
                        </thead>
                        <tbody id="pdf-table-body">
                            <!-- Rempli par script -->
                        </tbody>
                    </table>
                </div>
            </div> <!-- End Content Wrapper -->

            <!-- NEW FOOTER -->
            <div style="margin-top: auto; text-align: center; font-size: 8px; color: #1e3a8a; border-top: 2px solid #1e3a8a; padding-top: 10px;">
                <p style="margin: 0 0 2px 0;">15, Rue Abou Ali Ben Rahal, 1er étage Appt N°8 V.N Meknès - Tél.: 05 35 52 60 90 - Fax: 05 35 52 60 91</p>
                <p style="margin: 0 0 2px 0;">E-mail: betcam01@gmail.com - RC: 29915 - Patente: 17318252 - CNSS: 8258875 - IF: 40147134</p>
                <p style="margin: 0; font-weight: 700;">ICE : 0014 3853 0000 042</p>
            </div>
        </div>
    </div>
    
    <script>
        // MAIN LOGIC SCRIPT
        
        Chart.register(ChartDataLabels);

        // --- MATRICE DE CALCUL ---
        const MATRICE = [
            // 1. PP / Non Utilitaire
            { cat: "PP/Non Utilitaire", pMin: 0, pMax: 7, carb: "Diesel", ans: [0.20, 0.15, 0.10, 0.10, 0.10] },
            { cat: "PP/Non Utilitaire", pMin: 0, pMax: 7, carb: "Essence", ans: [0.20, 0.15, 0.10, 0.10, 0.10] },
            { cat: "PP/Non Utilitaire", pMin: 8, pMax: 11, carb: "Diesel", ans: [0.25, 0.20, 0.15, 0.10, 0.10] },
            { cat: "PP/Non Utilitaire", pMin: 8, pMax: 11, carb: "Essence", ans: [0.25, 0.20, 0.15, 0.10, 0.10] },
            { cat: "PP/Non Utilitaire", pMin: 12, pMax: 999, carb: "Diesel", ans: [0.27, 0.20, 0.15, 0.10, 0.10] },
            { cat: "PP/Non Utilitaire", pMin: 12, pMax: 999, carb: "Essence", ans: [0.30, 0.25, 0.20, 0.10, 0.10] },

            // 2. Location / Utilitaire
            { cat: "Location/Utilitaire", pMin: 0, pMax: 7, carb: "Diesel", ans: [0.25, 0.20, 0.15, 0.10, 0.10] },
            { cat: "Location/Utilitaire", pMin: 0, pMax: 7, carb: "Essence", ans: [0.25, 0.20, 0.15, 0.10, 0.10] },
            { cat: "Location/Utilitaire", pMin: 8, pMax: 11, carb: "Diesel", ans: [0.30, 0.25, 0.20, 0.15, 0.10] },
            { cat: "Location/Utilitaire", pMin: 8, pMax: 11, carb: "Essence", ans: [0.30, 0.25, 0.20, 0.15, 0.10] },
            { cat: "Location/Utilitaire", pMin: 12, pMax: 999, carb: "Diesel", ans: [0.32, 0.25, 0.20, 0.15, 0.10] },
            { cat: "Location/Utilitaire", pMin: 12, pMax: 999, carb: "Essence", ans: [0.32, 0.25, 0.20, 0.15, 0.10] },

            // 3. Bus et Camions
            { cat: "Bus et Camions", pMin: 0, pMax: 999, carb: "Diesel", ans: [0.35, 0.30, 0.25, 0.20, 0.15] },
            { cat: "Bus et Camions", pMin: 0, pMax: 999, carb: "Essence", ans: [0.40, 0.35, 0.30, 0.25, 0.20] },

            // 4. Semi-Remorque
            { cat: "Semi-Remorque", pMin: 0, pMax: 999, carb: "Diesel", ans: [0.35, 0.30, 0.25, 0.20, 0.15] },
            { cat: "Semi-Remorque", pMin: 0, pMax: 999, carb: "Essence", ans: [0.40, 0.35, 0.30, 0.25, 0.20] },

            // 5. Motocycle
            { cat: "Motocycle", pMin: 0, pMax: 999, carb: "Essence", ans: [0.20, 0.15, 0.10, 0.10, 0.10] },
            
            // 6. Engins
            { cat: "Engins/Agricole", pMin: 0, pMax: 999, carb: "Diesel", ans: [0, 0, 0, 0, 0] },
            { cat: "Engins/Agricole", pMin: 0, pMax: 999, carb: "Essence", ans: [0, 0, 0, 0, 0] }
        ];

        let chartEvo, chartDist;
        let tableDataForPDF = [];
        let finalCalculation = {};

        // Utility to safely set text content
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) {
                el.innerText = text;
            } else {
                console.warn(`Element with id '${id}' not found for text update.`);
            }
        }

        function formatFinance(num, withSuffix = true) {
            let formatted = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num).replace(/\u00a0/g, " ");
            return withSuffix ? formatted + " Dhs" : formatted;
        }

        window.handleEnter = function(e, el) {
            if (e.key === "Enter") { updateVrade(); el.blur(); }
        }

        window.finalizeFormat = function(el, rawId) {
            let cleanVal = el.value.replace(/\s/g, '').replace(',', '.');
            let numeric = parseFloat(cleanVal) || 0;
            document.getElementById(rawId).value = numeric;
            el.value = formatFinance(numeric, false);
            updateVrade();
        }

        window.getTaux = function(annee, cat, p, carb) {
            if (cat === "Engins/Agricole") return 0;
            if (annee >= 11) return 0.05;

            let line = MATRICE.find(l => l.cat === cat && p >= l.pMin && p <= l.pMax && l.carb === carb);
            if (!line) { line = MATRICE.find(l => l.cat === cat && p >= l.pMin && p <= l.pMax); }
            return line ? line.ans[Math.min(annee - 1, 4)] : 0.10;
        }

        window.getReferenceKmPerYear = function(cat, carb) {
            if (cat === "Motocycle") return 5000;
            if (cat === "Engins/Agricole") return 1500; 
            if (cat === "Bus et Camions" || cat === "Semi-Remorque") return 50000;
            if (carb === "Diesel") return 25000;
            return 20000; // Essence
        }

        window.toggleCorrectives = function() {
            const container = document.getElementById('container_correctifs');
            const chk = document.getElementById('chk_correctives');
            
            if (chk.checked) {
                container.classList.remove('hidden-section');
                container.classList.add('visible-section');
            } else {
                container.classList.remove('visible-section');
                container.classList.add('hidden-section');
            }
            updateVrade();
        }

        window.toggleTechReason = function() {
            const container = document.getElementById('tech_reason_container');
            const chk = document.getElementById('chk_tech_reform');
            
            if (chk.checked) {
                container.classList.remove('hidden-section');
                container.classList.add('visible-section');
            } else {
                container.classList.remove('visible-section');
                container.classList.add('hidden-section');
            }
            updateVrade();
        }

        window.toggleEcoReason = function() {
            const container = document.getElementById('eco_reason_container');
            const chk = document.getElementById('chk_eco_reform');
            
            if (chk.checked) {
                container.classList.remove('hidden-section');
                container.classList.add('visible-section');
            } else {
                container.classList.remove('visible-section');
                container.classList.add('hidden-section');
            }
            updateVrade();
        }

        // Nouvelle fonction pour récupérer les raisons cochées
        window.getSelectedTechReasons = function() {
            const checkboxes = document.querySelectorAll('input[name="tech_reason"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        window.getSelectedEcoReasons = function() {
            const checkboxes = document.querySelectorAll('input[name="eco_reason"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        window.updateVrade = function() {
            let valNeuve = parseFloat(document.getElementById('v_valeur_display').value.replace(/\s/g, '').replace(',', '.')) || 0;
            let montantDevis = parseFloat(document.getElementById('v_devis_display').value.replace(/\s/g, '').replace(',', '.')) || 0;
            let accordDevis = parseFloat(document.getElementById('v_accord_display').value.replace(/\s/g, '').replace(',', '.')) || 0;
            
            // Set raw for accord
            document.getElementById('v_accord_raw').value = accordDevis;

            const useCorrectives = document.getElementById('chk_correctives').checked;
            let kmCompteur = 0;
            let entretienPercent = 0;

            if (useCorrectives) {
                kmCompteur = parseFloat(document.getElementById('v_km_compteur').value) || 0;
                entretienPercent = parseFloat(document.getElementById('v_entretien').value) || 0;
            }

            // Logic Tech Reform
            const isTechReform = document.getElementById('chk_tech_reform').checked;
            const selectedTechReasons = getSelectedTechReasons();
            const techReasonDisplay = selectedTechReasons.length > 0 ? selectedTechReasons.join(", ") : "Aucun motif sélectionné";

            // --- UI HIDING LOGIC FOR AUDIT TABLE ---
            const uiAuditSection = document.getElementById('ui-audit-section');
            if (isTechReform) {
                uiAuditSection.style.display = 'none';
            } else {
                uiAuditSection.style.display = 'block';
            }

            document.getElementById('v_valeur_raw').value = valNeuve;
            document.getElementById('v_devis_raw').value = montantDevis;

            const dmecInput = document.getElementById('v_dmec').value;
            const sinistreInput = document.getElementById('v_sinistre').value;
            const cat = document.getElementById('v_cat').value;
            const pf = parseInt(document.getElementById('v_pf').value) || 0;
            const carb = document.getElementById('v_carb').value;

            if(!dmecInput || !sinistreInput || valNeuve <= 0) return;

            const dmec = new Date(dmecInput);
            const sinistre = new Date(sinistreInput);
            const tableRows = [];
            const labels = ["Neuf"];
            const plotData = [valNeuve];

            let valAct = valNeuve;
            let dAnniv = new Date(dmec);
            let annee = 1;

            while(true) {
                let dStart = new Date(dAnniv);
                let dNext = new Date(dStart);
                dNext.setFullYear(dStart.getFullYear() + 1);
                let dEndEff = dNext > sinistre ? new Date(sinistre) : new Date(dNext.getTime() - 86400000);
                const jours = Math.ceil(Math.abs(dEndEff - dStart) / 86400000) + 1;
                const t = getTaux(annee, cat, pf, carb);
                const perte = dNext > sinistre ? (valAct * t * (jours / 365)) : (valAct * t);
                const valFin = valAct - perte;

                tableRows.push({ annee, start: dStart, end: dEndEff, t, valDeb: valAct, perte, valFin, jours });
                labels.push("An " + annee);
                plotData.push(valFin);

                if(dNext > sinistre) break;
                valAct = valFin;
                dAnniv = dNext;
                annee++;
            }

            const valBase = tableRows[tableRows.length - 1].valFin;
            const ageAnnees = (sinistre - dmec) / (1000 * 60 * 60 * 24 * 365.25);
            
            let montantAdjKm = 0;
            let montantAdjEntretien = 0;

            if (useCorrectives) {
                const refKmAn = getReferenceKmPerYear(cat, carb);
                const kmTheorique = refKmAn * ageAnnees;
                let ratioKm = 0;
                if(kmTheorique > 0) {
                    ratioKm = ((kmCompteur - kmTheorique) / kmTheorique) / 2;
                }
                if(ratioKm > 0.20) ratioKm = 0.20;
                if(ratioKm < -0.20) ratioKm = -0.20;
                montantAdjKm = valBase * (-ratioKm);

                montantAdjEntretien = valBase * (entretienPercent / 100);

                const adjKmEl = document.getElementById('disp_adj_km');
                adjKmEl.innerText = (montantAdjKm >= 0 ? "+" : "") + formatFinance(montantAdjKm);
                adjKmEl.className = montantAdjKm >= 0 ? "font-bold text-emerald-500" : "font-bold text-rose-500";

                const adjEntEl = document.getElementById('disp_adj_ent');
                adjEntEl.innerText = (montantAdjEntretien >= 0 ? "+" : "") + formatFinance(montantAdjEntretien);
                adjEntEl.className = montantAdjEntretien >= 0 ? "font-bold text-emerald-500" : "font-bold text-rose-500";
            }

            // Calcul valeur technique "brute" (avant majoration marché)
            const valTechnique = valBase + montantAdjKm + montantAdjEntretien;

            // --- NOUVELLE LOGIQUE MAJORATION MARCHÉ ---
            const marketPercent = parseInt(document.getElementById('v_market_boost').value) || 0;
            const marketValueAdded = valTechnique * (marketPercent / 100);
            const valFinale = valTechnique + marketValueAdded; // C'est la VRADE Finale

            // Mise à jour UI Majoration
            document.getElementById('market-percent-display').innerText = "+" + marketPercent + "%";
            document.getElementById('market-value-added').innerText = "+" + formatFinance(marketValueAdded);
            document.getElementById('kpi-final-retained').innerText = formatFinance(valFinale);

            // --- NOUVELLE LOGIQUE SEUIL : OPTION APPLY TO THRESHOLD ---
            const applyToThreshold = document.getElementById('chk_apply_to_threshold').checked;
            
            let baseForThreshold = valBase;
            if (applyToThreshold) {
                baseForThreshold = valTechnique; 
            }
            const seuilReform = (baseForThreshold * 2) / 3;
            
            // Logic Eco Reform (Math)
            // Note: If Accord exists AND Accord > Threshold, it triggers Math Reform too
            let referenceCost = montantDevis;
            if (accordDevis > 0) {
                referenceCost = accordDevis;
            }
            const isEcoReformMath = referenceCost > seuilReform;
            
            // Logic Eco Reform (Manual)
            const isEcoReformManual = document.getElementById('chk_eco_reform').checked;
            
            // On combine les raisons
            let ecoReasonsList = [];
            // 1. Math check
            if (isEcoReformMath) {
                let labelCost = accordDevis > 0 ? "Accord" : "Devis";
                ecoReasonsList.push(`${labelCost} (${formatFinance(referenceCost, false)}) > Seuil 2/3 (${formatFinance(seuilReform, false)})`);
            }
            // 2. Manual checks
            if (isEcoReformManual) {
                const manualReasons = getSelectedEcoReasons();
                ecoReasonsList = ecoReasonsList.concat(manualReasons);
            }
            const ecoReasonDisplay = ecoReasonsList.length > 0 ? ecoReasonsList.join("<br>") : "Aucun motif sélectionné";
            
            // Mise à jour label
            const labelSeuil = document.getElementById('kpi-seuil-label');
            if (applyToThreshold) {
                labelSeuil.innerText = "Seuil Réforme (2/3 Tech.)";
                document.getElementById('dash_recap_seuil_label').innerText = "Seuil (2/3 Tech.)";
            } else {
                labelSeuil.innerText = "Seuil Réforme (2/3 Base)";
                document.getElementById('dash_recap_seuil_label').innerText = "Seuil (2/3 Base)";
            }

            tableDataForPDF = tableRows;
            finalCalculation = {
                valBase: valBase,
                adjKm: montantAdjKm,
                adjEntretien: montantAdjEntretien,
                marketPercent: marketPercent,
                marketValueAdded: marketValueAdded,
                valFinale: valFinale, // VRADE
                valTechnique: valTechnique, // Base + Correctifs (Sans marché)
                seuil: seuilReform,
                km: kmCompteur,
                useCorrectives: useCorrectives,
                accordDevis: accordDevis, // New prop
                
                isTechReform: isTechReform,
                techReasons: selectedTechReasons,
                techReasonDisplay: techReasonDisplay,
                
                isEcoReformManual: isEcoReformManual,
                ecoReasons: ecoReasonsList,
                ecoReasonDisplay: ecoReasonDisplay,
                
                isEcoReformMath: isEcoReformMath,
                applyToThreshold: applyToThreshold,
                anciennete: `${annee-1} ans, ${tableRows[tableRows.length-1].jours} jrs`
            };
            
            window.latestCalculation = finalCalculation;

            document.getElementById('label-vv-type').innerText = useCorrectives ? "Corrigée" : "Standard";
            document.getElementById('label-vv-sub').innerText = useCorrectives ? "Incluant correctifs KM & Entretien" : "Calcul sur dépréciation temporelle uniquement";

            document.getElementById('kpi-vv-final').innerText = formatFinance(valFinale);
            document.getElementById('kpi-val-base').innerText = formatFinance(valBase);
            const totalImpact = montantAdjKm + montantAdjEntretien;
            const impactEl = document.getElementById('kpi-impact-total');
            impactEl.innerText = (totalImpact >= 0 && totalImpact > 0 ? "+" : "") + formatFinance(totalImpact);
            impactEl.className = totalImpact >= 0 ? "text-lg font-medium text-emerald-400 font-mono-num" : "text-lg font-medium text-rose-400 font-mono-num";
            
            document.getElementById('kpi-anciennete').innerText = finalCalculation.anciennete;
            document.getElementById('kpi-seuil').innerText = formatFinance(seuilReform);

            document.getElementById('dash_recap_val_neuf').innerText = formatFinance(valNeuve);
            document.getElementById('dash_recap_val_base').innerText = formatFinance(valBase);
            document.getElementById('dash_recap_impact').innerText = (totalImpact >= 0 && totalImpact > 0 ? "+" : "") + formatFinance(totalImpact);
            
            // "Valeur Vénale Technique" dans le tableau recap = Valeur Technique
            document.getElementById('dash_recap_val_venale').innerText = formatFinance(valTechnique);
            document.getElementById('dash_recap_seuil').innerText = formatFinance(seuilReform);

            const decisionBox = document.getElementById('decision-box');
            const decisionLabel = document.getElementById('decision-label');
            const decisionSub = document.getElementById('decision-sub');
            const decisionReason = document.getElementById('decision-reason');
            
            // --- DECISION LOGIC START ---
            
            // 1. Priority: Tech Reform (Always overrides)
            if (isTechReform) {
                decisionBox.className = "decision-card bg-red-100 p-8 rounded-[2.5rem] pro-shadow border-t-8 border-red-800 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden";
                decisionLabel.innerText = "RÉFORME TECHNIQUE";
                decisionLabel.className = "text-2xl md:text-3xl font-extrabold text-red-900 tracking-tight";
                decisionSub.classList.remove('hidden');
                
                if(selectedTechReasons.length > 1) {
                    decisionReason.innerText = selectedTechReasons.length + " critères identifiés (voir PDF)";
                    decisionReason.className = "block mt-1 font-bold text-red-700";
                } else {
                    decisionReason.innerText = techReasonDisplay;
                    decisionReason.className = "block mt-1 font-bold text-red-700";
                }
            } 
            // 2. Special Case: ACCORD ON DEVIS < THRESHOLD (Overrides Eco Reform if Accord is provided and valid)
            else if (accordDevis > 0 && accordDevis <= seuilReform) {
                decisionBox.className = "decision-card bg-emerald-100 p-8 rounded-[2.5rem] pro-shadow border-t-8 border-emerald-600 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden";
                decisionLabel.innerText = "RÉPARATION (ACCORD)";
                decisionLabel.className = "text-2xl md:text-3xl font-bold text-emerald-800 tracking-tight";
                decisionSub.classList.remove('hidden');
                
                decisionReason.innerHTML = `Accord (${formatFinance(accordDevis, false)}) < Seuil 2/3`;
                decisionReason.className = "block mt-1 font-bold text-emerald-700";
            }
            // 3. Priority: Eco Reform (Math or Manual)
            else if (isEcoReformManual || isEcoReformMath) {
                decisionBox.className = "decision-card bg-orange-50 p-8 rounded-[2.5rem] pro-shadow border-t-8 border-orange-500 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden";
                decisionLabel.innerText = "RÉFORME ÉCONOMIQUE";
                decisionLabel.className = "text-2xl md:text-3xl font-bold text-orange-600 tracking-tight";
                decisionSub.classList.remove('hidden');
                
                if(ecoReasonsList.length > 1) {
                    decisionReason.innerHTML = ecoReasonsList.length + " critères identifiés (voir PDF)";
                    decisionReason.className = "block mt-1 font-bold text-orange-700";
                } else {
                    decisionReason.innerHTML = ecoReasonDisplay; 
                    decisionReason.className = "block mt-1 font-bold text-orange-700";
                }
            } 
            // 4. Default: Repair
            else {
                decisionSub.classList.add('hidden');
                if (montantDevis > 0) {
                    decisionBox.className = "decision-card bg-emerald-50 p-8 rounded-[2.5rem] pro-shadow border-t-8 border-emerald-500 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden";
                    decisionLabel.innerText = "RÉPARATION DU VÉHICULE";
                    decisionLabel.className = "text-2xl md:text-3xl font-medium text-emerald-700";
                } else {
                    // Default state
                    decisionBox.className = "decision-card bg-white p-8 rounded-[2.5rem] pro-shadow border-t-8 border-slate-200 flex flex-col md:flex-row items-center justify-between gap-8 relative overflow-hidden";
                    decisionLabel.innerText = "En attente de saisie";
                    decisionLabel.className = "text-2xl md:text-3xl font-medium text-slate-900 leading-tight";
                }
            }

            document.getElementById('vradeTable').innerHTML = tableDataForPDF.map(r => `
                <tr class="hover:bg-indigo-50/20 transition-colors">
                    <td class="p-6 text-slate-500 font-medium">Année ${r.annee}</td>
                    <td class="p-6 text-sm text-slate-900 font-normal">${r.start.toLocaleDateString('fr-FR')} au ${r.end.toLocaleDateString('fr-FR')}</td>
                    <td class="p-6 text-center text-slate-600 font-medium">${(r.t*100).toFixed(0)}%</td>
                    <td class="p-6 text-right text-slate-600">${formatFinance(r.valDeb, false)}</td>
                    <td class="p-6 text-right text-rose-400 font-medium">-${formatFinance(r.perte, false)}</td>
                    <td class="p-6 text-right text-slate-800 font-bold">${formatFinance(r.valFin, false)}</td>
                    <td class="p-6 text-center text-slate-400 font-medium">${r.jours}</td>
                </tr>
            `).join('');

            updateCharts(labels, plotData, valFinale, valNeuve - valFinale);
        }

        window.updateCharts = function(labels, values, finalVal, lossVal) {
            if(chartEvo) chartEvo.destroy();
            if(chartDist) chartDist.destroy();
            const ctx1 = document.getElementById('chartEvo').getContext('2d');
            chartEvo = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Valeur résiduelle', data: values, borderColor: '#1e3a8a', backgroundColor: 'rgba(30, 58, 138, 0.05)', fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff', pointBorderWidth: 3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => formatFinance(v, false) } } } }
            });
            const ctx2 = document.getElementById('chartDist').getContext('2d');
            const gradGreen = ctx2.createLinearGradient(0, 0, 0, 400);
            gradGreen.addColorStop(0, '#10b981'); gradGreen.addColorStop(1, '#065f46'); 
            const gradRed = ctx2.createLinearGradient(0, 0, 0, 400);
            gradRed.addColorStop(0, '#f43f5e'); gradRed.addColorStop(1, '#9f1239'); 
            chartDist = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Valeur Restante', 'Dépréciation'],
                    datasets: [{ data: [finalVal, lossVal], backgroundColor: [gradGreen, gradRed], borderWidth: 0, hoverOffset: 15, borderRadius: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 30, font: {size: 11, weight: '700'}, color: '#1e3a8a' } },
                        datalabels: {
                            color: '#ffffff', font: { weight: 'bold', size: 12, family: 'Inter' },
                            textShadowColor: 'rgba(0,0,0,0.7)', textShadowBlur: 8,
                            formatter: (value, ctx) => {
                                let sum = 0;
                                ctx.chart.data.datasets[0].data.map(data => { sum += data; });
                                return (value * 100 / sum).toFixed(1) + "%";
                            },
                            anchor: 'center', align: 'center', display: (context) => context.dataset.data[context.dataIndex] > 0
                        }
                    }
                }
            });
        }

        // --- GÉNÉRATION DU PDF VIA TEMPLATE ---
        window.formatDateToFrench = function(dateStr) {
            if (!dateStr) return "--/--/----";
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        window.downloadExpertisePDF = function() {
            const valNeuve = document.getElementById('v_valeur_raw').value;
            if(parseFloat(valNeuve) <= 0) {
                alert("Veuillez d'abord effectuer un calcul complet.");
                return;
            }

            if (typeof html2pdf === 'undefined') {
                alert("La librairie PDF n'est pas chargée. Vérifiez votre connexion internet.");
                return;
            }
            
            // Renamed for clarity and safety
            const pdfTemplate = document.getElementById('pdf-export-template'); 
            
            if (!pdfTemplate) {
                alert("Erreur: Le modèle PDF est introuvable.");
                return;
            }
            
            // Re-fetch reference for filename logic specifically
            const refInput = document.getElementById('v_ref');
            const refDossier = refInput ? refInput.value.trim() : '';

            // Update PDF Content
            safeSetText('pdf-ref-display', refDossier ? refDossier : "VRADE-AUTOGEN");
            
            const mat = document.getElementById('v_mat').value || '--';
            safeSetText('pdf-mat', mat);

            // New fields update
            const nomAssure = document.getElementById('v_nom_assure').value || '--';
            safeSetText('pdf-nom-assure', nomAssure);
            
            // === NOUVEAU CHAMP COMPAGNIE ===
            const cieAssurance = document.getElementById('v_cie_assurance').value || '--';
            safeSetText('pdf-cie-assurance', cieAssurance);

            const numSinistre = document.getElementById('v_num_sinistre').value || '--';
            safeSetText('pdf-num-sinistre', numSinistre);

            const marqueModele = document.getElementById('v_marque_modele').value || '--';
            safeSetText('pdf-marque-modele', marqueModele);

            // --- MISE A JOUR JS POUR L'ENERGIE ET LA PUISSANCE ---
            const energie = document.getElementById('v_carb').value || '--';
            safeSetText('pdf-energie', energie);

            const puissance = document.getElementById('v_pf').value || '--';
            safeSetText('pdf-puissance', puissance + " CV");
            
            // --- MISE A JOUR JS POUR LA CATEGORIE ---
            const catSelect = document.getElementById('v_cat');
            const catText = catSelect.options[catSelect.selectedIndex].text;
            safeSetText('pdf-cat', catText);
            // ----------------------------------------------------

            const dateExpertise = document.getElementById('v_date_expertise').value;
            safeSetText('pdf-date-expertise', formatDateToFrench(dateExpertise));

            safeSetText('pdf-date-now', new Date().toLocaleDateString('fr-FR'));
            safeSetText('pdf-val-neuve', formatFinance(parseFloat(document.getElementById('v_valeur_raw').value)));
            safeSetText('pdf-dmec', formatDateToFrench(document.getElementById('v_dmec').value));
            safeSetText('pdf-sinistre', formatDateToFrench(document.getElementById('v_sinistre').value));
            safeSetText('pdf-devis', formatFinance(parseFloat(document.getElementById('v_devis_raw').value)));
            
            // PDF Accord Handling
            const accordVal = parseFloat(document.getElementById('v_accord_raw').value) || 0;
            const rowAccord = document.getElementById('pdf-row-accord');
            if(rowAccord) {
                if(accordVal > 0) {
                    safeSetText('pdf-accord', formatFinance(accordVal));
                    rowAccord.style.display = 'table-row';
                } else {
                    rowAccord.style.display = 'none';
                }
            }

            safeSetText('pdf-anciennete', finalCalculation.anciennete);
            safeSetText('pdf-val-base', formatFinance(finalCalculation.valBase));
            
            // Update Recap Table in PDF
            safeSetText('pdf-recap-val-neuf', formatFinance(parseFloat(document.getElementById('v_valeur_raw').value)));
            safeSetText('pdf-recap-val-base', formatFinance(finalCalculation.valBase));
            const totalImpact = finalCalculation.adjKm + finalCalculation.adjEntretien;
            const impactSign = (totalImpact >= 0 && totalImpact > 0) ? "+" : "";
            safeSetText('pdf-recap-impact', impactSign + formatFinance(totalImpact));
            
            // Valeur Technique before Market Boost
            safeSetText('pdf-recap-val-venale', formatFinance(finalCalculation.valTechnique));
            safeSetText('pdf-recap-seuil', formatFinance(finalCalculation.seuil));

            const rowKm = document.getElementById('pdf-row-km');
            const rowEnt = document.getElementById('pdf-row-ent');
            
            if (finalCalculation.useCorrectives) {
                if(rowKm) {
                    rowKm.style.display = 'table-row';
                    safeSetText('pdf-km', finalCalculation.km + " km");
                }
                if(rowEnt) {
                    rowEnt.style.display = 'table-row';
                }
                
                const adjKmEl = document.getElementById('pdf-adj-km');
                if (adjKmEl) {
                    adjKmEl.innerText = (finalCalculation.adjKm >= 0 ? "+" : "") + formatFinance(finalCalculation.adjKm);
                    adjKmEl.style.color = "#000";
                }

                const adjEntEl = document.getElementById('pdf-adj-entretien');
                if (adjEntEl) {
                    adjEntEl.innerText = (finalCalculation.adjEntretien >= 0 ? "+" : "") + formatFinance(finalCalculation.adjEntretien);
                    adjEntEl.style.color = "#000";
                }
            } else {
                if(rowKm) rowKm.style.display = 'none';
                if(rowEnt) rowEnt.style.display = 'none';
                safeSetText('pdf-km', "Non renseigné");
            }

            safeSetText('pdf-vv-final', formatFinance(finalCalculation.valFinale));
            safeSetText('pdf-seuil', formatFinance(finalCalculation.seuil));
            
            // Update PDF label based on option
            const pdfThresholdLabel = document.getElementById('pdf-seuil-label');
            if (pdfThresholdLabel) {
                 if (finalCalculation.applyToThreshold) {
                    pdfThresholdLabel.innerText = "Seuil Réforme (2/3 VRADE)";
                } else {
                    pdfThresholdLabel.innerText = "Seuil Réforme (2/3 de Base)";
                }
            }
            
            const decBox = document.getElementById('pdf-decision-box');
            const techReasonBox = document.getElementById('pdf-tech-reason');
            const techReasonText = document.getElementById('pdf-tech-reason-text');
            const pdfAuditSection = document.getElementById('pdf-audit-section');

            if(finalCalculation.isTechReform) {
                // PDF FOR TECHNICAL REFORM
                if(decBox) {
                    decBox.innerText = "RÉFORME TECHNIQUE";
                    decBox.style.color = "#7f1d1d"; // Dark Red
                    decBox.style.borderColor = "#7f1d1d";
                    decBox.style.backgroundColor = "#fee2e2";
                }
                if(techReasonBox) techReasonBox.style.display = "block";
                
                // MULTI-REASON PDF FORMATTING
                if(techReasonText) {
                    if (finalCalculation.techReasons.length > 0) {
                        const listHtml = finalCalculation.techReasons.map(r => `• ${r}`).join('<br>');
                        techReasonText.innerHTML = "Motifs Techniques:<br>" + `<div style='padding-left:5px; margin-top:2px; font-weight:normal;'>${listHtml}</div>`;
                    } else {
                        techReasonText.innerText = "Motif : Non spécifié.";
                    }
                }
                
                if(pdfAuditSection) pdfAuditSection.style.display = 'none';
            
            // SPECIAL CASE: Accord Validé (Priorité sur Eco)
            } else if (finalCalculation.accordDevis > 0 && finalCalculation.accordDevis <= finalCalculation.seuil) {
                if(decBox) {
                    decBox.innerText = "RÉPARATION (ACCORD VALIDÉ)";
                    decBox.style.color = "#065f46"; // Green
                    decBox.style.borderColor = "#065f46";
                    decBox.style.backgroundColor = "#ecfdf5";
                }
                // Show reason why it's repair
                if(techReasonBox) techReasonBox.style.display = "block";
                if(techReasonText) {
                    techReasonText.innerHTML = `<span style="color:#065f46">Accord (${formatFinance(finalCalculation.accordDevis, false)}) inférieur au Seuil 2/3.</span>`;
                }
                
                if(pdfAuditSection) pdfAuditSection.style.display = 'block';

            } else if (finalCalculation.isEcoReformManual || finalCalculation.isEcoReformMath) {
                // PDF FOR ECONOMIC REFORM
                if(decBox) {
                    decBox.innerText = "RÉFORME ÉCONOMIQUE";
                    decBox.style.color = "#c2410c"; // Orange/Red
                    decBox.style.borderColor = "#c2410c";
                    decBox.style.backgroundColor = "#fff7ed";
                }
                if(techReasonBox) techReasonBox.style.display = "block";
                
                if(techReasonText) {
                    if (finalCalculation.ecoReasons.length > 0) {
                         const listHtml = finalCalculation.ecoReasons.map(r => `• ${r}`).join('<br>');
                         techReasonText.innerHTML = "Motifs Économiques:<br>" + `<div style='padding-left:5px; margin-top:2px; font-weight:normal;'>${listHtml}</div>`;
                    } else {
                         techReasonText.innerText = "Motif : Non spécifié";
                    }
                }

                if(pdfAuditSection) pdfAuditSection.style.display = 'block';

            } else {
                // PDF FOR REPAIR
                if(techReasonBox) techReasonBox.style.display = "none";
                if(pdfAuditSection) pdfAuditSection.style.display = 'block';
                
                if(decBox) {
                    decBox.innerText = "RÉPARATION DU VÉHICULE";
                    decBox.style.color = "#065f46";
                    decBox.style.borderColor = "#065f46";
                    decBox.style.backgroundColor = "#fff";
                }
            }

            // Génération des lignes du tableau PDF avec plus de padding
            document.getElementById('pdf-table-body').innerHTML = tableDataForPDF.map(r => `
                <tr>
                    <td style="padding: 4px 6px; border: 1px solid #e2e8f0;">Année ${r.annee}</td>
                    <td style="padding: 4px 6px; border: 1px solid #e2e8f0;">${r.start.toLocaleDateString()} au ${r.end.toLocaleDateString()}</td>
                    <td style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: center;">${(r.t*100).toFixed(0)}%</td>
                    <td style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: right;">-${formatFinance(r.perte, false)}</td>
                    <td style="padding: 4px 6px; border: 1px solid #e2e8f0; text-align: right; font-weight: 700;">${formatFinance(r.valFin, false)}</td>
                </tr>
            `).join('');

            // --- PDF INJECTION FOR MARKET BOOST ---
            let boostRow = document.getElementById('pdf-boost-row');
            const vvFinalElement = document.getElementById('pdf-vv-final');
            
            if(!boostRow && vvFinalElement) {
                const finalRow = vvFinalElement.parentNode;
                if(finalRow && finalRow.parentNode) {
                    boostRow = document.createElement('tr');
                    boostRow.id = 'pdf-boost-row';
                    // Ajout du padding augmenté ici aussi
                    boostRow.innerHTML = `
                        <td style="padding: 6px; border-right: 1px solid #e2e8f0;">Majoration Marché</td>
                        <td style="padding: 6px; border-right: 1px solid #e2e8f0;"><span id="pdf-boost-pct">0</span>%</td>
                        <td style="padding: 6px; border-right: 1px solid #e2e8f0;">-</td>
                        <td id="pdf-boost-val" style="padding: 6px; border-right: 1px solid #e2e8f0; font-weight: bold; color: #000;">+0,00 Dhs</td>
                        <td style="padding: 6px;">-</td>
                    `;
                    finalRow.parentNode.insertBefore(boostRow, finalRow);
                }
            }
            
            if (boostRow) {
                if (finalCalculation.marketPercent > 0) {
                    safeSetText('pdf-boost-pct', finalCalculation.marketPercent);
                    safeSetText('pdf-boost-val', "+" + formatFinance(finalCalculation.marketValueAdded));
                    boostRow.style.display = 'table-row';
                } else {
                    boostRow.style.display = 'none';
                }
            }

            // --- STRATÉGIE "LOADING" SANS OVERLAY GLITCH ---
            const appWrapper = document.getElementById('app-wrapper');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // 1. Afficher l'écran de chargement propre (couvre tout)
            loadingOverlay.style.display = 'flex';
            
            setTimeout(() => {
                // Safety check inside closure
                if (!pdfTemplate) return;

                appWrapper.style.display = 'none';
                pdfTemplate.style.display = 'flex'; // Changed to flex to match template style
                window.scrollTo(0, 0);

                let filenameRef = refDossier ? refDossier.replace(/[\/\\ ]/g, '-') : 'AUTOGEN';
                
                const opt = {
                    margin: 0, // IMPORTANT: Marge zéro pour éviter la page blanche
                    filename: 'Expertise_BETCAM_' + filenameRef + '.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true }, 
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(pdfTemplate).save()
                .then(() => {
                    // 3. Restauration
                    pdfTemplate.style.display = 'none';
                    appWrapper.style.display = 'block';
                    loadingOverlay.style.display = 'none'; // Retirer le loading
                    window.scrollTo(0, 0);
                })
                .catch((err) => {
                    console.error(err);
                    alert("Erreur PDF : " + err.message);
                    pdfTemplate.style.display = 'none';
                    appWrapper.style.display = 'block';
                    loadingOverlay.style.display = 'none';
                });
            }, 100); // Court délai pour permettre au DOM de render le loadingOverlay
        }

        window.onload = updateVrade;
    </script>
</body>
</html>
